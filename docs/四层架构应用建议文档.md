# ä¿®ä»™åº”ç”¨å››å±‚æ¶æ„å»ºè®®æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [å‘½åè§„èŒƒ](#å‘½åè§„èŒƒ)
3. [èŒè´£åˆ†å·¥](#èŒè´£åˆ†å·¥)
4. [ä»£ç é‡å¤è§„é¿](#ä»£ç é‡å¤è§„é¿)
5. [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
6. [å®ç°ç¤ºä¾‹](#å®ç°ç¤ºä¾‹)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

### å››å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è¡¨ç¤ºå±‚ (Frontend)          â”‚
â”‚        React + TypeScript           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†• HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ§åˆ¶å™¨å±‚ (Controller)        â”‚
â”‚      è¯·æ±‚å¤„ç† + æ•°æ®ç»„è£…             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†• å‡½æ•°è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       æ•°æ®è®¿é—®å±‚ (DAL)              â”‚
â”‚    æ•°æ®è®¿é—® + ç®€å•ä¸šåŠ¡é€»è¾‘           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†• SQL/ORM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®åº“å±‚ (Database)          â”‚
â”‚      SQLite/MySQL + JSONæ–‡ä»¶        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ å‘½åè§„èŒƒ

### 1. DALå±‚å‘½åè§„èŒƒ

#### æ–‡ä»¶å‘½å
```
- DAL_UserAccess.ts          // ç”¨æˆ·æ•°æ®è®¿é—®
- DAL_DiscipleAccess.ts      // å¼Ÿå­æ•°æ®è®¿é—®
- DAL_CultivationAccess.ts   // ä¿®ç‚¼æ•°æ®è®¿é—®
- DAL_ResourceAccess.ts      // èµ„æºæ•°æ®è®¿é—®
- DAL_SectAccess.ts          // å®—é—¨æ•°æ®è®¿é—®
```

#### ç±»å‘½å
```typescript
// DALç±»å‘½åï¼šDAL_ + ä¸šåŠ¡åŸŸ + Access
class DAL_UserAccess
class DAL_DiscipleAccess
class DAL_CultivationAccess
class DAL_ResourceAccess
class DAL_SectAccess
```

#### å‡½æ•°å‘½å
```typescript
// æŸ¥è¯¢æ“ä½œï¼šget + ä¸šåŠ¡å¯¹è±¡ + By + æ¡ä»¶
getUserById(id: string)
getDisciplesByMasterId(masterId: string)
getCultivationStageByRealmLevel(realmLevel: number)

// åˆ›å»ºæ“ä½œï¼šcreate + ä¸šåŠ¡å¯¹è±¡
createUser(userData: UserCreateData)
createDiscipleRecord(discipleData: DiscipleCreateData)

// æ›´æ–°æ“ä½œï¼šupdate + ä¸šåŠ¡å¯¹è±¡ + å…·ä½“å­—æ®µ
updateUserCultivationValue(userId: string, newValue: number)
updateUserRealmLevel(userId: string, newLevel: number)

// åˆ é™¤æ“ä½œï¼šdelete + ä¸šåŠ¡å¯¹è±¡ + By + æ¡ä»¶
deleteUserById(id: string)
deleteDisciplesByMasterId(masterId: string)

// éªŒè¯æ“ä½œï¼švalidate + ä¸šåŠ¡è§„åˆ™
validateCultivationValueLimit(userId: string, newValue: number)
validateBreakthroughConditions(userId: string)

// è®¡ç®—æ“ä½œï¼šcalculate + è®¡ç®—å†…å®¹
calculateMaxCultivationValue(realmLevel: number)
calculateSectTotalResources(sectId: string)
```

### 2. Controllerå±‚å‘½åè§„èŒƒ

#### æ–‡ä»¶å‘½å
```
- LeaderController.ts        // æŒé—¨æ§åˆ¶å™¨
- DiscipleController.ts      // å¼Ÿå­æ§åˆ¶å™¨
- CultivationController.ts   // ä¿®ç‚¼æ§åˆ¶å™¨
- ResourceController.ts      // èµ„æºæ§åˆ¶å™¨
- SectController.ts          // å®—é—¨æ§åˆ¶å™¨
```

#### å‡½æ•°å‘½å
```typescript
// HTTPæ–¹æ³• + ä¸šåŠ¡æ“ä½œ
getLeaderInfo(req: Request, res: Response)
postUpdateCultivation(req: Request, res: Response)
putBreakthroughRealm(req: Request, res: Response)
deleteDisciple(req: Request, res: Response)

// å†…éƒ¨è¾…åŠ©å‡½æ•°ï¼šhandle + å…·ä½“æ“ä½œ
handleLeaderInfoRequest(req: Request)
handleCultivationUpdate(userId: string, newValue: number)
handleErrorResponse(res: Response, error: Error)
```

### 3. æ•°æ®åº“å±‚å‘½åè§„èŒƒ

#### è¡¨å‘½åï¼ˆè›‡å½¢å‘½åæ³•ï¼‰
```sql
-- ç”¨æˆ·ç›¸å…³
users                    -- ç”¨æˆ·åŸºç¡€ä¿¡æ¯
user_skills             -- ç”¨æˆ·æŠ€èƒ½å…³è”
user_cultivation_log    -- ä¿®ç‚¼è®°å½•

-- å¼Ÿå­ç›¸å…³
disciples               -- å¼Ÿå­ä¿¡æ¯
disciple_training_log   -- å¼Ÿå­è®­ç»ƒè®°å½•

-- å®—é—¨ç›¸å…³
sect_info               -- å®—é—¨åŸºç¡€ä¿¡æ¯
sect_resources          -- å®—é—¨èµ„æº
sect_events             -- å®—é—¨äº‹ä»¶

-- ä¿®ç‚¼ç›¸å…³
cultivation_stages      -- ä¿®ç‚¼é˜¶æ®µ
cultivation_methods     -- ä¿®ç‚¼åŠŸæ³•
```

#### å­—æ®µå‘½å
```sql
-- ä¸»é”®ï¼šè¡¨å_id
user_id, disciple_id, sect_id

-- å¤–é”®ï¼šå…³è”è¡¨å_id
master_id, sect_id, method_id

-- æ—¶é—´å­—æ®µ
created_at, updated_at, deleted_at
join_date, breakthrough_time

-- çŠ¶æ€å­—æ®µ
is_active, is_deleted, can_breakthrough
status, state, level

-- æ•°å€¼å­—æ®µ
cultivation_value, realm_level, talent_value
spirit_stone_count, herb_count
```

### 4. è¡¨ç¤ºå±‚å‘½åè§„èŒƒ

#### ç»„ä»¶å‘½åï¼ˆPascalCaseï¼‰
```typescript
// é¡µé¢ç»„ä»¶ï¼šä¸šåŠ¡å + Page
LeaderPage, DisciplePage, CultivationPage

// åŠŸèƒ½ç»„ä»¶ï¼šåŠŸèƒ½å + Component
CultivationProgress, SkillList, ResourceDisplay

// é€šç”¨ç»„ä»¶ï¼šGeneric + åŠŸèƒ½å
GenericTable, GenericModal, GenericForm
```

## ğŸ¯ èŒè´£åˆ†å·¥

### 1. æ•°æ®åº“å±‚èŒè´£

```sql
-- èŒè´£ï¼šæ•°æ®å­˜å‚¨å’ŒåŸºç¡€çº¦æŸ
-- ä¸åŒ…å«ï¼šä¸šåŠ¡é€»è¾‘ã€æ•°æ®è½¬æ¢

CREATE TABLE users (
    user_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    realm_level INT DEFAULT 1 CHECK (realm_level >= 1),
    cultivation_value BIGINT DEFAULT 0 CHECK (cultivation_value >= 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åŸºç¡€ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_users_realm_level ON users(realm_level);
CREATE INDEX idx_disciples_master_id ON disciples(master_id);
```

### 2. DALå±‚èŒè´£

```typescript
/**
 * DALå±‚èŒè´£ï¼š
 * 1. æ•°æ®åº“è®¿é—®æ“ä½œ
 * 2. ç®€å•æ•°æ®æ ¡éªŒ
 * 3. åŸºç¡€ä¸šåŠ¡è§„åˆ™éªŒè¯
 * 4. æ•°æ®æ ¼å¼è½¬æ¢
 * 5. é”™è¯¯å¤„ç†
 */

class DAL_UserAccess {
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«æ•°æ®è½¬æ¢ï¼‰
     */
    async getUserById(userId: string): Promise<UserInfo> {
        // 1. å‚æ•°æ ¡éªŒ
        this.validateUserId(userId);
        
        // 2. æ•°æ®åº“æŸ¥è¯¢
        const rawData = await this.db.query(
            'SELECT * FROM users WHERE user_id = ?', 
            [userId]
        );
        
        // 3. æ•°æ®è½¬æ¢
        return this.transformRawUserData(rawData);
    }
    
    /**
     * æ›´æ–°ä¿®ç‚¼å€¼ï¼ˆåŒ…å«ä¸šåŠ¡è§„åˆ™æ ¡éªŒï¼‰
     */
    async updateCultivationValue(userId: string, newValue: number): Promise<void> {
        // 1. å‚æ•°æ ¡éªŒ
        this.validateUserId(userId);
        this.validateCultivationValue(newValue);
        
        // 2. ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
        await this.validateCultivationLimit(userId, newValue);
        
        // 3. æ•°æ®æ›´æ–°
        await this.db.query(
            'UPDATE users SET cultivation_value = ?, updated_at = CURRENT_TIMESTAMP WHERE user_id = ?',
            [newValue, userId]
        );
    }
    
    /**
     * ç§æœ‰æ–¹æ³•ï¼šæ•°æ®æ ¡éªŒ
     */
    private validateUserId(userId: string): void {
        if (!userId || userId.trim() === '') {
            throw new Error('ç”¨æˆ·IDä¸èƒ½ä¸ºç©º');
        }
    }
    
    /**
     * ç§æœ‰æ–¹æ³•ï¼šä¸šåŠ¡è§„åˆ™æ ¡éªŒ
     */
    private async validateCultivationLimit(userId: string, newValue: number): Promise<void> {
        const user = await this.getUserById(userId);
        const maxValue = this.calculateMaxCultivationValue(user.realmLevel);
        
        if (newValue > maxValue) {
            throw new Error(`ä¿®ç‚¼å€¼ä¸èƒ½è¶…è¿‡å½“å‰å¢ƒç•Œä¸Šé™: ${maxValue}`);
        }
    }
}
```

### 3. Controllerå±‚èŒè´£

```typescript
/**
 * Controllerå±‚èŒè´£ï¼š
 * 1. HTTPè¯·æ±‚å¤„ç†
 * 2. å‚æ•°è§£æå’ŒéªŒè¯
 * 3. è°ƒç”¨DALå±‚æ–¹æ³•
 * 4. æ•°æ®ç»„è£…å’Œæ ¼å¼åŒ–
 * 5. é”™è¯¯å“åº”å¤„ç†
 */

class LeaderController {
    private dalUserAccess = new DAL_UserAccess();
    private dalCultivationAccess = new DAL_CultivationAccess();
    
    /**
     * è·å–æŒé—¨ä¿¡æ¯æ¥å£
     */
    async getLeaderInfo(req: Request, res: Response): Promise<void> {
        try {
            // 1. å‚æ•°è§£æ
            const { id } = req.body;
            
            // 2. è°ƒç”¨DALè·å–æ•°æ®
            const userInfo = await this.dalUserAccess.getUserById(id);
            const cultivationStage = await this.dalCultivationAccess.getCultivationStageByRealmLevel(userInfo.realmLevel);
            
            // 3. æ•°æ®ç»„è£…ï¼ˆä¸ºå‰ç«¯ä¼˜åŒ–ï¼‰
            const responseData = this.assembleLeaderInfoResponse(userInfo, cultivationStage);
            
            // 4. æˆåŠŸå“åº”
            res.json({
                status: 'success',
                data: responseData,
                timestamp: new Date().toISOString()
            });
            
        } catch (error) {
            // 5. é”™è¯¯å¤„ç†
            this.handleErrorResponse(res, error);
        }
    }
    
    /**
     * ç§æœ‰æ–¹æ³•ï¼šç»„è£…å“åº”æ•°æ®
     */
    private assembleLeaderInfoResponse(userInfo: UserInfo, cultivationStage: CultivationStage) {
        return {
            ...userInfo,
            cultivationStage,
            // å‰ç«¯éœ€è¦çš„è®¡ç®—å­—æ®µ
            progressPercentage: (userInfo.cultivationValue / cultivationStage.maxValue) * 100,
            canBreakthrough: userInfo.cultivationValue >= cultivationStage.maxValue,
            nextStage: cultivationStage.stage === 'åæœŸ' ? 'ä¸‹ä¸€å¢ƒç•Œ' : 'ä¸‹ä¸€é˜¶æ®µ'
        };
    }
    
    /**
     * ç§æœ‰æ–¹æ³•ï¼šé”™è¯¯å“åº”å¤„ç†
     */
    private handleErrorResponse(res: Response, error: any): void {
        console.error('Controlleré”™è¯¯:', error);
        
        const statusCode = error.name === 'ValidationError' ? 400 : 500;
        
        res.status(statusCode).json({
            status: 'error',
            message: error.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
            timestamp: new Date().toISOString()
        });
    }
}
```

### 4. è¡¨ç¤ºå±‚èŒè´£

```typescript
/**
 * è¡¨ç¤ºå±‚èŒè´£ï¼š
 * 1. ç”¨æˆ·ç•Œé¢æ¸²æŸ“
 * 2. ç”¨æˆ·äº¤äº’å¤„ç†
 * 3. çŠ¶æ€ç®¡ç†
 * 4. APIè°ƒç”¨
 * 5. æ•°æ®å±•ç¤ºæ ¼å¼åŒ–
 */

const LeaderPage: React.FC = () => {
    // 1. çŠ¶æ€ç®¡ç†
    const [leaderInfo, setLeaderInfo] = useState<LeaderInfo | null>(null);
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<string | null>(null);
    
    // 2. APIè°ƒç”¨
    const fetchLeaderInfo = useCallback(async () => {
        try {
            setLoading(true);
            setError(null);
            
            const response = await fetch('/api/leader/info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: 'leader_001' })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                setLeaderInfo(result.data);
            } else {
                setError(result.message);
            }
        } catch (err) {
            setError('è·å–æŒé—¨ä¿¡æ¯å¤±è´¥');
        } finally {
            setLoading(false);
        }
    }, []);
    
    // 3. ç”¨æˆ·äº¤äº’å¤„ç†
    const handleCultivationIncrease = useCallback(async () => {
        if (!leaderInfo) return;
        
        try {
            const response = await fetch('/api/leader/cultivation/increase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: leaderInfo.id, 
                    increaseValue: 1 
                })
            });
            
            if (response.ok) {
                // åˆ·æ–°æ•°æ®
                await fetchLeaderInfo();
            }
        } catch (err) {
            setError('ä¿®ç‚¼å¤±è´¥');
        }
    }, [leaderInfo, fetchLeaderInfo]);
    
    // 4. ç•Œé¢æ¸²æŸ“
    return (
        <div className="leader-page">
            {/* æ¸²æŸ“é€»è¾‘ */}
        </div>
    );
};
```

## ğŸ”„ ä»£ç é‡å¤è§„é¿

### 1. é€šç”¨å·¥å…·ç±»

```typescript
// src/utils/ValidationUtils.ts
export class ValidationUtils {
    /**
     * éªŒè¯IDæ ¼å¼
     */
    static validateId(id: string, fieldName: string = 'ID'): void {
        if (!id || id.trim() === '') {
            throw new Error(`${fieldName}ä¸èƒ½ä¸ºç©º`);
        }
        
        if (id.length > 50) {
            throw new Error(`${fieldName}é•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦`);
        }
    }
    
    /**
     * éªŒè¯æ•°å€¼èŒƒå›´
     */
    static validateNumberRange(value: number, min: number, max: number, fieldName: string): void {
        if (value < min || value > max) {
            throw new Error(`${fieldName}å¿…é¡»åœ¨${min}åˆ°${max}ä¹‹é—´`);
        }
    }
    
    /**
     * éªŒè¯å­—ç¬¦ä¸²é•¿åº¦
     */
    static validateStringLength(str: string, maxLength: number, fieldName: string): void {
        if (str && str.length > maxLength) {
            throw new Error(`${fieldName}é•¿åº¦ä¸èƒ½è¶…è¿‡${maxLength}ä¸ªå­—ç¬¦`);
        }
    }
}

// src/utils/DataTransformer.ts
export class DataTransformer {
    /**
     * è½¬æ¢ç”¨æˆ·åŸå§‹æ•°æ®
     */
    static transformRawUserData(rawData: any): UserInfo {
        return {
            id: rawData.user_id,
            name: rawData.name,
            title: rawData.title || '',
            realmLevel: rawData.realm_level,
            cultivationValue: rawData.cultivation_value,
            joinDate: rawData.join_date,
            createdAt: new Date(rawData.created_at),
            updatedAt: new Date(rawData.updated_at)
        };
    }
    
    /**
     * è½¬æ¢ä¿®ç‚¼é˜¶æ®µæ•°æ®
     */
    static transformCultivationStageData(rawData: any): CultivationStage {
        return {
            stageDivision: rawData.stage_division,
            majorRealm: rawData.major_realm,
            minorRealm: rawData.minor_realm,
            stage: rawData.stage,
            minValue: rawData.min_value,
            maxValue: rawData.max_value
        };
    }
}

// src/utils/ResponseFormatter.ts
export class ResponseFormatter {
    /**
     * æ ¼å¼åŒ–æˆåŠŸå“åº”
     */
    static success(data: any, message?: string) {
        return {
            status: 'success',
            data,
            message: message || 'æ“ä½œæˆåŠŸ',
            timestamp: new Date().toISOString()
        };
    }
    
    /**
     * æ ¼å¼åŒ–é”™è¯¯å“åº”
     */
    static error(message: string, code?: string) {
        return {
            status: 'error',
            message,
            code: code || 'UNKNOWN_ERROR',
            timestamp: new Date().toISOString()
        };
    }
}
```

### 2. åŸºç¡€DALæŠ½è±¡ç±»

```typescript
// src/dal/DAL_BaseAccess.ts
export abstract class DAL_BaseAccess {
    protected db: DatabaseConnection;
    
    constructor(db: DatabaseConnection) {
        this.db = db;
    }
    
    /**
     * é€šç”¨æŸ¥è¯¢æ–¹æ³•
     */
    protected async executeQuery<T>(sql: string, params: any[] = []): Promise<T[]> {
        try {
            return await this.db.query(sql, params);
        } catch (error) {
            console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', { sql, params, error });
            throw new Error('æ•°æ®åº“æ“ä½œå¤±è´¥');
        }
    }
    
    /**
     * é€šç”¨å•æ¡è®°å½•æŸ¥è¯¢
     */
    protected async executeQuerySingle<T>(sql: string, params: any[] = []): Promise<T | null> {
        const results = await this.executeQuery<T>(sql, params);
        return results.length > 0 ? results[0] : null;
    }
    
    /**
     * é€šç”¨æ›´æ–°æ–¹æ³•
     */
    protected async executeUpdate(sql: string, params: any[] = []): Promise<number> {
        try {
            const result = await this.db.execute(sql, params);
            return result.affectedRows;
        } catch (error) {
            console.error('æ•°æ®åº“æ›´æ–°é”™è¯¯:', { sql, params, error });
            throw new Error('æ•°æ®åº“æ›´æ–°å¤±è´¥');
        }
    }
    
    /**
     * é€šç”¨IDéªŒè¯
     */
    protected validateId(id: string, fieldName: string = 'ID'): void {
        ValidationUtils.validateId(id, fieldName);
    }
    
    /**
     * æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
     */
    protected async checkRecordExists(tableName: string, idField: string, id: string): Promise<boolean> {
        const sql = `SELECT 1 FROM ${tableName} WHERE ${idField} = ? LIMIT 1`;
        const result = await this.executeQuery(sql, [id]);
        return result.length > 0;
    }
}
```

### 3. é€šç”¨ControlleråŸºç±»

```typescript
// src/controllers/BaseController.ts
export abstract class BaseController {
    /**
     * é€šç”¨é”™è¯¯å¤„ç†
     */
    protected handleError(res: Response, error: any): void {
        console.error('Controlleré”™è¯¯:', error);
        
        let statusCode = 500;
        let message = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
        
        if (error.name === 'ValidationError') {
            statusCode = 400;
            message = error.message;
        } else if (error.name === 'NotFoundError') {
            statusCode = 404;
            message = error.message;
        } else if (error.message) {
            message = error.message;
        }
        
        res.status(statusCode).json(ResponseFormatter.error(message));
    }
    
    /**
     * é€šç”¨æˆåŠŸå“åº”
     */
    protected sendSuccess(res: Response, data: any, message?: string): void {
        res.json(ResponseFormatter.success(data, message));
    }
    
    /**
     * é€šç”¨å‚æ•°éªŒè¯
     */
    protected validateRequiredParams(params: any, requiredFields: string[]): void {
        for (const field of requiredFields) {
            if (!params[field]) {
                throw new Error(`ç¼ºå°‘å¿…éœ€å‚æ•°: ${field}`);
            }
        }
    }
}
```

## ğŸ“ ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ dal/                          # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ interfaces/               # DALæ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ IUserAccess.ts
â”‚   â”‚   â”œâ”€â”€ IDiscipleAccess.ts
â”‚   â”‚   â””â”€â”€ ICultivationAccess.ts
â”‚   â”œâ”€â”€ implementations/          # DALå…·ä½“å®ç°
â”‚   â”‚   â”œâ”€â”€ DAL_UserAccess.ts
â”‚   â”‚   â”œâ”€â”€ DAL_DiscipleAccess.ts
â”‚   â”‚   â””â”€â”€ DAL_CultivationAccess.ts
â”‚   â””â”€â”€ DAL_BaseAccess.ts        # DALåŸºç±»
â”‚
â”œâ”€â”€ controllers/                  # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ BaseController.ts        # æ§åˆ¶å™¨åŸºç±»
â”‚   â”œâ”€â”€ LeaderController.ts      # æŒé—¨æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ DiscipleController.ts    # å¼Ÿå­æ§åˆ¶å™¨
â”‚   â””â”€â”€ CultivationController.ts # ä¿®ç‚¼æ§åˆ¶å™¨
â”‚
â”œâ”€â”€ database/                     # æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ config/                  # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”œâ”€â”€ database.ts          # æ•°æ®åº“è¿æ¥é…ç½®
â”‚   â”‚   â””â”€â”€ migrations/          # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ interfaces/              # æ•°æ®åº“æ¥å£
â”‚   â”‚   â””â”€â”€ IDatabaseConnection.ts
â”‚   â””â”€â”€ implementations/         # æ•°æ®åº“å®ç°
â”‚       â”œâ”€â”€ SQLiteConnection.ts
â”‚       â””â”€â”€ MySQLConnection.ts
â”‚
â”œâ”€â”€ utils/                       # å·¥å…·ç±»
â”‚   â”œâ”€â”€ ValidationUtils.ts       # éªŒè¯å·¥å…·
â”‚   â”œâ”€â”€ DataTransformer.ts       # æ•°æ®è½¬æ¢å·¥å…·
â”‚   â”œâ”€â”€ ResponseFormatter.ts     # å“åº”æ ¼å¼åŒ–å·¥å…·
â”‚   â””â”€â”€ ErrorHandler.ts          # é”™è¯¯å¤„ç†å·¥å…·
â”‚
â”œâ”€â”€ types/                       # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ UserTypes.ts            # ç”¨æˆ·ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ DiscipleTypes.ts        # å¼Ÿå­ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ CultivationTypes.ts     # ä¿®ç‚¼ç›¸å…³ç±»å‹
â”‚   â””â”€â”€ CommonTypes.ts          # é€šç”¨ç±»å‹
â”‚
â””â”€â”€ pages/                       # è¡¨ç¤ºå±‚ï¼ˆReactç»„ä»¶ï¼‰
    â”œâ”€â”€ LeaderPage.tsx
    â”œâ”€â”€ DisciplePage.tsx
    â””â”€â”€ CultivationPage.tsx
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†ç­–ç•¥

```typescript
// è‡ªå®šä¹‰é”™è¯¯ç±»
export class ValidationError extends Error {
    constructor(message: string) {
        super(message);
        this.name = 'ValidationError';
    }
}

export class NotFoundError extends Error {
    constructor(resource: string) {
        super(`${resource}ä¸å­˜åœ¨`);
        this.name = 'NotFoundError';
    }
}

export class BusinessRuleError extends Error {
    constructor(message: string) {
        super(message);
        this.name = 'BusinessRuleError';
    }
}
```

### 2. æ—¥å¿—è®°å½•

```typescript
// src/utils/Logger.ts
export class Logger {
    static info(message: string, data?: any): void {
        console.log(`[INFO] ${new Date().toISOString()} - ${message}`, data || '');
    }
    
    static error(message: string, error?: any): void {
        console.error(`[ERROR] ${new Date().toISOString()} - ${message}`, error || '');
    }
    
    static warn(message: string, data?: any): void {
        console.warn(`[WARN] ${new Date().toISOString()} - ${message}`, data || '');
    }
}
```

### 3. é…ç½®ç®¡ç†

```typescript
// src/config/AppConfig.ts
export const AppConfig = {
    database: {
        type: process.env.DB_TYPE || 'sqlite',
        host: process.env.DB_HOST || 'localhost',
        port: parseInt(process.env.DB_PORT || '3306'),
        database: process.env.DB_NAME || 'xiuxian_db',
        username: process.env.DB_USER || 'root',
        password: process.env.DB_PASS || ''
    },
    server: {
        port: parseInt(process.env.PORT || '3015'),
        cors: {
            origin: process.env.CORS_ORIGIN?.split(',') || ['http://localhost:3000']
        }
    },
    cultivation: {
        defaultIncreaseValue: 1,
        maxRealmLevel: 66,
        breakthroughCooldown: 5000 // 5ç§’
    }
};
```

### 4. å•å…ƒæµ‹è¯•ç¤ºä¾‹

```typescript
// tests/dal/DAL_UserAccess.test.ts
import { DAL_UserAccess } from '../../src/dal/implementations/DAL_UserAccess';
import { MockDatabaseConnection } from '../mocks/MockDatabaseConnection';

describe('DAL_UserAccess', () => {
    let dalUserAccess: DAL_UserAccess;
    let mockDb: MockDatabaseConnection;
    
    beforeEach(() => {
        mockDb = new MockDatabaseConnection();
        dalUserAccess = new DAL_UserAccess(mockDb);
    });
    
    describe('getUserById', () => {
        it('åº”è¯¥è¿”å›æ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯', async () => {
            // å‡†å¤‡æµ‹è¯•æ•°æ®
            const mockUserData = {
                user_id: 'test_001',
                name: 'æµ‹è¯•ç”¨æˆ·',
                realm_level: 3
            };
            
            mockDb.setQueryResult([mockUserData]);
            
            // æ‰§è¡Œæµ‹è¯•
            const result = await dalUserAccess.getUserById('test_001');
            
            // éªŒè¯ç»“æœ
            expect(result.id).toBe('test_001');
            expect(result.name).toBe('æµ‹è¯•ç”¨æˆ·');
            expect(result.realmLevel).toBe(3);
        });
        
        it('åº”è¯¥åœ¨ç”¨æˆ·IDä¸ºç©ºæ—¶æŠ›å‡ºé”™è¯¯', async () => {
            await expect(dalUserAccess.getUserById(''))
                .rejects
                .toThrow('ç”¨æˆ·IDä¸èƒ½ä¸ºç©º');
        });
    });
});
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- åˆ›å»ºå¿…è¦çš„ç´¢å¼•
CREATE INDEX idx_users_realm_level ON users(realm_level);
CREATE INDEX idx_disciples_master_id ON disciples(master_id);
CREATE INDEX idx_cultivation_log_user_id ON user_cultivation_log(user_id);

-- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
SELECT * FROM disciples 
WHERE master_id = ? 
ORDER BY created_at DESC 
LIMIT ? OFFSET ?;
```

### 2. ç¼“å­˜ç­–ç•¥

```typescript
// src/utils/CacheManager.ts
export class CacheManager {
    private static cache = new Map<string, { data: any; expiry: number }>();
    
    static set(key: string, data: any, ttlMs: number = 300000): void {
        const expiry = Date.now() + ttlMs;
        this.cache.set(key, { data, expiry });
    }
    
    static get<T>(key: string): T | null {
        const item = this.cache.get(key);
        
        if (!item) return null;
        
        if (Date.now() > item.expiry) {
            this.cache.delete(key);
            return null;
        }
        
        return item.data as T;
    }
}
```

### 3. è¿æ¥æ± ç®¡ç†

```typescript
// src/database/ConnectionPool.ts
export class ConnectionPool {
    private pool: DatabaseConnection[] = [];
    private maxConnections = 10;
    
    async getConnection(): Promise<DatabaseConnection> {
        if (this.pool.length > 0) {
            return this.pool.pop()!;
        }
        
        if (this.activeConnections < this.maxConnections) {
            return await this.createConnection();
        }
        
        // ç­‰å¾…å¯ç”¨è¿æ¥
        return await this.waitForConnection();
    }
    
    releaseConnection(connection: DatabaseConnection): void {
        this.pool.push(connection);
    }
}
```

---

## ğŸ“‹ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†ä¿®ä»™åº”ç”¨å››å±‚æ¶æ„çš„å®Œæ•´å®æ–½æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š

1. **æ¸…æ™°çš„å‘½åè§„èŒƒ** - ç¡®ä¿ä»£ç å¯è¯»æ€§å’Œä¸€è‡´æ€§
2. **æ˜ç¡®çš„èŒè´£åˆ†å·¥** - é¿å…å±‚çº§é—´èŒè´£æ··ä¹±
3. **æœ‰æ•ˆçš„ä»£ç é‡ç”¨** - å‡å°‘é‡å¤ä»£ç ï¼Œæé«˜ç»´æŠ¤æ€§
4. **å®Œæ•´çš„ç›®å½•ç»“æ„** - ä¾¿äºé¡¹ç›®ç®¡ç†å’Œæ‰©å±•
5. **æœ€ä½³å®è·µæŒ‡å¯¼** - ç¡®ä¿ä»£ç è´¨é‡å’Œæ€§èƒ½

éµå¾ªè¿™äº›è§„èŒƒå’Œå»ºè®®ï¼Œå¯ä»¥æ„å»ºå‡ºç»“æ„æ¸…æ™°ã€æ˜“äºç»´æŠ¤ã€æ€§èƒ½è‰¯å¥½çš„ä¿®ä»™åº”ç”¨ç³»ç»Ÿã€‚