# 验证中间件修复方案

## 修复概述

基于数据库表结构分析，需要对 `static-data.ts` 验证中间件进行全面修正，确保与实际数据库字段和约束完全一致。

## 1. 境界数据验证修复

### 当前问题
- 字段名称完全不匹配
- 数值范围不正确 (1-100 vs 0-63)
- 缺少必要字段验证

### 修复方案

```typescript
/**
 * 境界数据验证 - 修正版
 * 基于 realm_data 表结构
 */
export const validateCreateRealmData = createValidationMiddleware([
  body('realm_level')
    .isInt({ min: 0, max: 63 })
    .withMessage('境界等级必须是0-63之间的整数'),
    
  body('stage_division')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('阶段划分长度必须在1-20个字符之间'),
    
  body('major_realm')
    .notEmpty()
    .isLength({ min: 1, max: 30 })
    .withMessage('大境界名称长度必须在1-30个字符之间'),
    
  body('minor_realm')
    .notEmpty()
    .isLength({ min: 1, max: 30 })
    .withMessage('小境界名称长度必须在1-30个字符之间'),
    
  body('stage')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('阶段名称长度必须在1-20个字符之间'),
    
  body('cultivation_start_value')
    .optional()
    .isInt({ min: 0 })
    .withMessage('修炼值起始必须是非负整数'),
    
  body('base_cultivation_limit')
    .isInt({ min: 0 })
    .withMessage('基础修炼值上限必须是非负整数'),
    
  body('base_cultivation_speed')
    .isInt({ min: 0 })
    .withMessage('基础修炼速度必须是非负整数'),
    
  body('base_physical_strength')
    .isInt({ min: 0 })
    .withMessage('基础体质强度必须是非负整数'),
    
  body('base_spiritual_strength')
    .isInt({ min: 0 })
    .withMessage('基础灵力强度必须是非负整数'),
    
  body('base_soul_strength')
    .isInt({ min: 0 })
    .withMessage('基础灵魂强度必须是非负整数'),
    
  body('base_spiritual_storage')
    .optional()
    .isInt({ min: 0 })
    .withMessage('基础灵气储值必须是非负整数'),
    
  body('base_blood_storage')
    .optional()
    .isInt({ min: 0 })
    .withMessage('基础血气储值必须是非负整数'),
    
  body('base_mental_storage')
    .optional()
    .isInt({ min: 0 })
    .withMessage('基础精神力储值必须是非负整数'),
    
  body('base_spiritual_recovery_rate')
    .optional()
    .isInt({ min: 0 })
    .withMessage('基础灵气恢复速率必须是非负整数'),
    
  body('base_blood_recovery_rate')
    .optional()
    .isInt({ min: 0 })
    .withMessage('基础血气恢复速率必须是非负整数'),
    
  body('base_mental_recovery_rate')
    .optional()
    .isInt({ min: 0 })
    .withMessage('基础精神力恢复速率必须是非负整数')
]);
```

## 2. 技能数据验证修复

### 修复方案

```typescript
/**
 * 技能数据验证 - 修正版
 * 基于 skill_data 表结构
 */
export const validateCreateSkillData = createValidationMiddleware([
  body('skill_id')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('技能ID长度必须在1-20个字符之间'),
    
  body('skill_name')
    .notEmpty()
    .isLength({ min: 1, max: 50 })
    .withMessage('技能名称长度必须在1-50个字符之间'),
    
  body('skill_type')
    .isIn(['心法', '功法', '武技', '秘术', '禁术'])
    .withMessage('技能类型必须是心法、功法、武技、秘术或禁术'),
    
  body('skill_realm_requirement')
    .isInt({ min: 0, max: 63 })
    .withMessage('境界要求必须是0-63之间的整数'),
    
  body('skill_description')
    .optional()
    .isString()
    .withMessage('技能描述必须是字符串'),
    
  body('skill_power')
    .isInt({ min: 0 })
    .withMessage('技能威力必须是非负整数')
]);
```

## 3. 武器数据验证修复

### 修复方案

```typescript
/**
 * 武器数据验证 - 修正版
 * 基于 weapon_data 表结构
 */
export const validateCreateWeaponData = createValidationMiddleware([
  body('weapon_id')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('武器ID长度必须在1-20个字符之间'),
    
  body('weapon_name')
    .notEmpty()
    .isLength({ min: 1, max: 50 })
    .withMessage('武器名称长度必须在1-50个字符之间'),
    
  body('weapon_type')
    .isIn(['剑', '刀', '棍', '枪', '鞭', '锤', '扇', '笛', '其他'])
    .withMessage('武器类型必须是剑、刀、棍、枪、鞭、锤、扇、笛或其他'),
    
  body('weapon_realm_requirement')
    .isInt({ min: 0, max: 63 })
    .withMessage('境界要求必须是0-63之间的整数'),
    
  body('weapon_description')
    .optional()
    .isString()
    .withMessage('武器描述必须是字符串'),
    
  body('weapon_attack_power')
    .isInt({ min: 0 })
    .withMessage('攻击力必须是非负整数'),
    
  body('weapon_special_effect')
    .optional()
    .isString()
    .withMessage('特殊效果必须是字符串')
]);
```

## 4. 物品数据验证修复

### 修复方案

```typescript
/**
 * 物品数据验证 - 修正版
 * 基于 item_data 表结构
 */
export const validateCreateItemData = createValidationMiddleware([
  body('item_id')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('物品ID长度必须在1-20个字符之间'),
    
  body('item_name')
    .notEmpty()
    .isLength({ min: 1, max: 50 })
    .withMessage('物品名称长度必须在1-50个字符之间'),
    
  body('item_type')
    .isIn(['武器', '防具', '饰品', '消耗品', '材料', '任务物品', '法宝'])
    .withMessage('物品类型必须是武器、防具、饰品、消耗品、材料、任务物品或法宝'),
    
  body('quality')
    .isIn(['普通', '优秀', '稀有', '史诗', '传说', '神器'])
    .withMessage('物品品质必须是普通、优秀、稀有、史诗、传说或神器'),
    
  body('description')
    .optional()
    .isString()
    .withMessage('物品描述必须是字符串'),
    
  body('realm_requirement')
    .optional()
    .isInt({ min: 0, max: 63 })
    .withMessage('境界要求必须是0-63之间的整数'),
    
  body('attack_power')
    .optional()
    .isInt({ min: 0 })
    .withMessage('攻击力加成必须是非负整数'),
    
  body('defense_power')
    .optional()
    .isInt({ min: 0 })
    .withMessage('防御力加成必须是非负整数'),
    
  body('health_bonus')
    .optional()
    .isInt({ min: 0 })
    .withMessage('生命值加成必须是非负整数'),
    
  body('mana_bonus')
    .optional()
    .isInt({ min: 0 })
    .withMessage('法力值加成必须是非负整数'),
    
  body('special_effect')
    .optional()
    .isString()
    .withMessage('特殊效果必须是字符串'),
    
  body('is_stackable')
    .optional()
    .isBoolean()
    .withMessage('是否可堆叠必须是布尔值'),
    
  body('max_stack_size')
    .optional()
    .isInt({ min: 1 })
    .withMessage('最大堆叠数量必须是正整数'),
    
  body('sell_price')
    .optional()
    .isInt({ min: 0 })
    .withMessage('出售价格必须是非负整数'),
    
  body('buy_price')
    .optional()
    .isInt({ min: 0 })
    .withMessage('购买价格必须是非负整数'),
    
  body('is_bind_on_pickup')
    .optional()
    .isBoolean()
    .withMessage('拾取绑定必须是布尔值'),
    
  body('is_bind_on_equip')
    .optional()
    .isBoolean()
    .withMessage('装备绑定必须是布尔值')
]);
```

## 5. 宗门数据验证修复

### 修复方案

```typescript
/**
 * 宗门数据验证 - 修正版
 * 基于 zongmen_data 表结构
 */
export const validateCreateZongmenData = createValidationMiddleware([
  body('zongmen_id')
    .notEmpty()
    .isLength({ min: 8, max: 8 })
    .withMessage('宗门ID必须是8位字符'),
    
  body('zongmen_name')
    .notEmpty()
    .isLength({ min: 1, max: 50 })
    .withMessage('宗门名称长度必须在1-50个字符之间'),
    
  body('description')
    .optional()
    .isString()
    .withMessage('宗门描述必须是字符串'),
    
  body('founder')
    .optional()
    .isLength({ min: 1, max: 20 })
    .withMessage('创始人名称长度必须在1-20个字符之间'),
    
  body('established_date')
    .optional()
    .isISO8601()
    .withMessage('创建日期格式无效，请使用ISO8601格式'),
    
  body('realm_level_required')
    .isInt({ min: 0, max: 63 })
    .withMessage('加入所需境界必须是0-63之间的整数')
]);
```

## 6. 体质数据验证补充

### 新增验证规则

```typescript
/**
 * 体质数据验证
 * 基于 body_type_data 表结构
 */
export const validateCreateBodyTypeData = createValidationMiddleware([
  body('body_type_id')
    .notEmpty()
    .isLength({ min: 4, max: 4 })
    .withMessage('体质ID必须是4位字符'),
    
  body('body_type_name')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('体质名称长度必须在1-20个字符之间'),
    
  body('description')
    .optional()
    .isString()
    .withMessage('体质描述必须是字符串'),
    
  body('physical_bonus')
    .optional()
    .isInt({ min: 0 })
    .withMessage('体质强度加成必须是非负整数'),
    
  body('spiritual_bonus')
    .optional()
    .isInt({ min: 0 })
    .withMessage('灵力强度加成必须是非负整数'),
    
  body('soul_bonus')
    .optional()
    .isInt({ min: 0 })
    .withMessage('灵魂强度加成必须是非负整数')
]);
```

## 7. 成就数据验证补充

### 新增验证规则

```typescript
/**
 * 成就数据验证
 * 基于 achievement_data 表结构
 */
export const validateCreateAchievementData = createValidationMiddleware([
  body('achievement_id')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('成就ID长度必须在1-20个字符之间'),
    
  body('achievement_name')
    .notEmpty()
    .isLength({ min: 1, max: 50 })
    .withMessage('成就名称长度必须在1-50个字符之间'),
    
  body('achievement_type')
    .isIn(['区域', '世界', '特殊'])
    .withMessage('成就类型必须是区域、世界或特殊'),
    
  body('description')
    .optional()
    .isString()
    .withMessage('成就描述必须是字符串'),
    
  body('reward')
    .optional()
    .isString()
    .withMessage('成就奖励必须是字符串'),
    
  body('difficulty')
    .isInt({ min: 1, max: 10 })
    .withMessage('难度系数必须是1-10之间的整数')
]);
```

## 8. 角色相关验证补充

### 角色基础信息验证

```typescript
/**
 * 角色基础信息验证
 * 基于 character_base_info 表结构
 */
export const validateCreateCharacterBaseInfo = createValidationMiddleware([
  body('character_uuid')
    .notEmpty()
    .isLength({ min: 10, max: 10 })
    .withMessage('角色UUID必须是10位字符'),
    
  body('character_name')
    .notEmpty()
    .isLength({ min: 1, max: 20 })
    .withMessage('角色姓名长度必须在1-20个字符之间'),
    
  body('character_gender')
    .isIn(['男', '女', '其他'])
    .withMessage('角色性别必须是男、女或其他'),
    
  body('character_birthday')
    .optional()
    .isISO8601()
    .withMessage('角色生日格式无效'),
    
  body('character_dao_hao')
    .optional()
    .isLength({ min: 1, max: 20 })
    .withMessage('道号长度必须在1-20个字符之间'),
    
  body('character_realm_Level')
    .optional()
    .isInt({ min: 0, max: 63 })
    .withMessage('境界等级必须是0-63之间的整数'),
    
  body('cultivatingState')
    .optional()
    .isIn(['未修练', '正在修炼', '闭关中', '受伤修炼中', '顿悟中'])
    .withMessage('修炼状态无效'),
    
  body('character_physicalAttributes')
    .optional()
    .isIn(['金', '木', '水', '火', '土'])
    .withMessage('体质五行属性必须是金、木、水、火或土'),
    
  body('zongMenJoinBool')
    .optional()
    .isBoolean()
    .withMessage('是否加入宗门必须是布尔值'),
    
  body('zongMen_id')
    .optional()
    .isLength({ min: 8, max: 8 })
    .withMessage('宗门ID必须是8位字符'),
    
  body('title_1_id')
    .optional()
    .isIn(['外门弟子', '内门弟子', '核心弟子', '长老', '掌门'])
    .withMessage('宗门身份无效'),
    
  body('title_2_id')
    .optional()
    .isIn(['初入宗门', '略有小成', '宗门栋梁', '宗门支柱', '宗门传奇'])
    .withMessage('宗门成就无效')
]);
```

## 实施计划

### 第一阶段：立即修复 (1-2天)
1. 更新所有枚举值为中文
2. 修正数值范围约束
3. 更新字段名称匹配数据库

### 第二阶段：功能完善 (3-5天)
1. 补充缺失的验证规则
2. 添加新的数据表验证
3. 完善错误消息

### 第三阶段：测试验证 (2-3天)
1. 单元测试覆盖
2. 集成测试验证
3. 性能测试优化

## 注意事项

1. **向后兼容性**：保持 legacy.ts 不变，确保旧版API继续工作
2. **渐进式更新**：分批次更新，避免影响现有功能
3. **测试覆盖**：每个修改都需要对应的测试用例
4. **文档更新**：同步更新API文档和使用说明

## 预期效果

修复完成后，验证中间件将：
- ✅ 与数据库表结构100%一致
- ✅ 支持所有数据库字段验证
- ✅ 提供准确的错误提示
- ✅ 确保数据完整性和一致性
- ✅ 提高系统稳定性和可靠性